def getAppContainerName() {
    return 'pmdevel/codenite-demo-app'
}

def startContainer(String containerVersion, String containerId, String containerPort, String profile) {
    String containerName = getAppContainerName()
    String alias = containerName.replace('/', '-') + "-" + containerId
    String javaOpts = "-e JAVA_OPTS=-Dspring.profiles.active=${profile}"
    sh "docker run --rm  --name ${alias} -d -p ${containerPort}:9090 ${javaOpts} ${containerName}:${containerVersion}"
}

def stopContainer(String containerId) {
    String containerName = getAppContainerName() + '-' + containerId
    String alias = containerName.replace('/', '-')
    sh "docker stop ${alias}"
}


def checkOutTestCode() {
    echo 'Check-out test code...'
    // Use pipeline parameter for Git URL
    git credentialsId: 'github-pmdevel', url: 'https://github.com/pmdevel/jenkins2-demo-source-webtest.git'
}

def runTests(String profile, String sutUrl, String sutVersion, String testsToRun) {
    sh "mvn clean test -Dtest=${testsToRun} -Dspring.profiles.active=${profile} -Dsut.url=${sutUrl} -Dsut.version=${sutVersion}"
}

boolean isContainerRunning(String containerId) {
    def isRunning = sh(
            script: "docker inspect --format=\"{{ .State.Running }}\" ${containerId} || exit 0",
            returnStdout: true
    ).trim()

    if (isRunning == 'true') {
        return true
    }

    return false
}

//<<<<<<<<<<<<<<<<<<<<<<<< PIPELINE START >>>>>>>>>>>>>>>>>>>>>>>>
stage('Build and JUnit Test') {
    node('maven') {

        echo 'Check-out code...'
        // Use pipeline parameter for Git URL
        git credentialsId: 'github-pmdevel', url: 'https://github.com/pmdevel/jenkins2-demo-source-webapp.git'
        echo 'Building...'

        // Let Maven help you to create a "release" version. Use BUILD_NUMBER from Jenkins
        sh 'mvn build-helper:parse-version versions:set -DnewVersion=\\${parsedVersion.majorVersion}.\\${parsedVersion.minorVersion}.$BUILD_NUMBER versions:commit '

        // Get version from pom
        def pom = readMavenPom file: 'pom.xml'
        writeFile file: "version.properties", text: "version=${pom.version}"

        sh 'cat version.properties'

        sh "mvn clean test "

        // Publish test result...
        sh "mkdir -p testresult/junittest"
        sh "cp target/surefire-reports/TEST*.xml testresult/junittest"
        sh "rm -rf target/surefire-reports "
        sh "find testresult/junittest"
        step([$class: 'ArtifactArchiver', artifacts: '**/target/*.jar', fingerprint: true])
        step([$class: 'JUnitResultArchiver', testResults: '**/testresult/junittest/TEST-*.xml'])

        stash includes: "version.properties", name: "version"
    }
}

stage('Build Docker Container') {
    node('maven') {
        echo 'Junit testing...'
        unstash "version"

        //sh "mvn package docker:build -DpushImage "
        sh "mvn package docker:build -DskipTests"
    }
}

stage('System Test (Parallel)') {

    node('maven') {
        git credentialsId: 'github-pmdevel', url: 'https://github.com/pmdevel/jenkins2-demo-source-webtest.git'
        stash includes: "**/*", name: "all"
    }
    parallel(
            "system-tests-suite1": {
                node('maven') {
                    unstash "all"
                    def props = readProperties file: 'version.properties'
                    def containerVersion = props.version
                    def containerName = getAppContainerName()
                    def containerPort = '9001'
                    def containerId = 'systemtest1'
                    echo "Starting container ${containerName}:${containerPort}..."
                    startContainer(containerVersion, containerId, containerPort, 'systemtest');
                    echo "Starting test of container ${containerName}:${containerPort}..."
                    runTests('systemtest', "http://172.17.0.4:9090", containerVersion, "**/systemtest/*_Suite1*");
                    step([$class: 'JUnitResultArchiver', testResults: '**/surefire-reports/TEST-*.xml'])
                    stopContainer('systemtest1')
                }
            },
            "system-tests-suite2": {
                node('maven') {
                    unstash "all"
                    def props = readProperties file: 'version.properties'
                    def containerVersion = props.version
                    def containerName = getAppContainerName()
                    def containerPort = '9002'
                    def containerId = 'systemtest2'
                    echo "Starting ${containerName}:${containerPort}..."
                    startContainer(containerVersion, containerId, containerPort, 'systemtest');
                    echo "Starting test of container ${containerName}:${containerPort}..."
                    runTests('systemtest', "http://172.17.0.5:9090", containerVersion, "**/systemtest/*_Suite2*");
                    step([$class: 'JUnitResultArchiver', testResults: '**/surefire-reports/TEST-*.xml'])
                    stopContainer('systemtest2')
                }
            }
    )

}

stage('Acceptance Test') {
    node('maven') {
        echo 'Acceptance Testing...'
        unstash "version"
        sh 'cat version.properties'
        def props = readProperties file: 'version.properties'

        def containerName = getAppContainerName()
        def containerVersion = props.version
        def containerPort = '9003'
        def containerId = 'acceptance1'

        // Start container
        echo "Starting container ${containerName}:${containerPort}"
        startContainer(containerVersion, containerId, containerPort, 'acceptancetest')
        sleep(5)
        // Start test
        echo "Start tests of container ${containerName}:${containerPort}"
        runTests('acceptancetest', "http://172.17.0.4:9090", containerVersion, "**/acceptancetest/*");
        step([$class: 'JUnitResultArchiver', testResults: '**/surefire-reports/TEST-*.xml'])
        stopContainer(containerId);
    }
}

stage('Deploy to PRODUCTION') {
    node('maven') {
        echo 'Deploying to PRODUCTION...'
        unstash "version"
        sh 'cat version.properties'
        def props = readProperties file: 'version.properties'
        echo "Application version: ${props.version}"
        def containerVersion = props.version
        def containerName = getAppContainerName()
        def containerPort = '9004'
        def containerId = 'production'
        // Stop running container...

        if (isContainerRunning(containerId)) {
            // It should be... in production...
            echo "Stopping ${containerName} for upgrade..."
            stopContainer(containerId)
        }

        echo "Starting ${containerName}..."
        startContainer(containerVersion, containerId, containerPort, 'production');

    }
}
